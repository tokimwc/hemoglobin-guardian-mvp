# アーキテクチャ設計書

## システム概要

### アーキテクチャの特徴
- マイクロサービスアーキテクチャ
- サーバーレスアーキテクチャ（Cloud Run）
- クリーンアーキテクチャに基づいたコード設計
- イベント駆動型アーキテクチャ

## システム構成図

```
[Frontend (Flutter)]
         ↓
[Cloud Run (FastAPI)]
         ↓
    ┌────┴────┐
    ↓         ↓
[Vision AI] [Vertex AI]
    ↓         ↓
[Cloud Storage] [Firestore]
```

## コンポーネント構成

### バックエンドサービス（Cloud Run）
```
backend/
├── src/
│   ├── services/
│   │   ├── vision_service.py    # 画像解析サービス
│   │   ├── gemini_service.py    # アドバイス生成サービス
│   │   └── firebase_service.py  # データ永続化サービス
│   ├── models/
│   │   ├── request.py          # リクエストモデル
│   │   └── response.py         # レスポンスモデル
│   └── utils/
│       ├── color_analysis.py   # 色解析ユーティリティ
│       └── image_processing.py # 画像処理ユーティリティ
├── tests/
│   ├── integration/           # 統合テスト
│   └── performance/          # パフォーマンステスト
└── main.py                   # エントリーポイント
```

## レイヤー構成

### プレゼンテーション層
- FastAPI エンドポイント
- リクエスト/レスポンスのバリデーション
- エラーハンドリング

### ビジネスロジック層
- 画像解析サービス
  - 爪領域の検出
  - 色解析と正規化
  - 画質評価
- アドバイス生成サービス
  - Gemini APIとの連携
  - プロンプト生成
  - レスポンスパース

### データアクセス層
- Firebase Firestore
  - 解析結果の永続化
  - ユーザー履歴管理
- Cloud Storage
  - 画像ファイルの保存

## 主要なワークフロー

### 1. 画像解析フロー
1. クライアントから画像をアップロード
2. Vision AIで爪領域を検出
3. HSV色空間で色解析を実行
4. 画質評価を実施
5. リスクスコアを計算

### 2. アドバイス生成フロー
1. 解析結果を基にプロンプトを生成
2. Gemini APIでアドバイスを生成
3. レスポンスをパースして構造化
4. キャッシュに結果を保存

### 3. データ永続化フロー
1. 解析結果をFirestoreに保存
2. 画像をCloud Storageに保存
3. ユーザー履歴を更新

## 非機能要件

### パフォーマンス
- レスポンスタイム: 4秒以内
- 同時リクエスト処理: 最大2件
- キャッシュTTL: 1時間

### スケーラビリティ
- Cloud Runの自動スケーリング
- Firestoreのスケーラブルなデータ構造

### セキュリティ
- Cloud IAMによるアクセス制御
- APIキーの安全な管理
- 環境変数による機密情報の管理

### 可用性
- Cloud Runの自動復旧機能
- エラー時のフォールバック処理
- 定期的なヘルスチェック

## エラーハンドリング

### リトライメカニズム
```python
{
    "max_retries": 3,
    "initial_delay_ms": 1000,
    "max_delay_ms": 5000,
    "backoff_factor": 2.0
}
```

### エラーレスポンス
```python
{
    "error": {
        "code": "ERROR_CODE",
        "message": "ユーザーフレンドリーなメッセージ",
        "details": ["エラーの詳細情報"],
        "timestamp": "ISO8601形式のタイムスタンプ"
    }
}
```

## モニタリングと監視

### メトリクス
- リクエスト数
- レスポンスタイム
- エラーレート
- リソース使用率

### ログ
- アプリケーションログ
- エラーログ
- アクセスログ
- パフォーマンスログ

## デプロイメント

### CI/CD パイプライン
1. コードの静的解析
2. ユニットテスト実行
3. 統合テスト実行
4. コンテナイメージのビルド
5. Cloud Runへのデプロイ

### ロールバック戦略
- 自動ロールバックのトリガー
- 手動ロールバック手順
- バージョン管理方針 